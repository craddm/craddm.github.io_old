---
title: "Ratcliff RT sims"
output: html_notebook
---


```{r loadPackages}
library(tidyverse)
library(afex)
library(copula)
```

Reaction times can be modelled as coming from an ex-Gaussian distribution. An ex-Gaussian (which isn't pining for the fjords) is the sum of a Gaussian and an exponential distribution. It has three parameters - the mean, standard deviation, and tau. Tau controls the degree of skew.

```{r}
exGauss <- data.frame(RT = rnorm(1000,400,40)+rexp(1000,.005))
ggplot(exGauss,aes(RT))+geom_histogram()+theme_bw()

```

As always, however, other things come into play during psychology experiments. People get bored or press buttons too quickly. Our distributions become contaminated with outliers. Here's a bunch of distributions produced by combining two distributions: a reference distribution which exemplifies the process of interest, and an outlier distribution with a mean 1 or 2 standard deviations away from the mean of the reference distribution.

```{r exGfun}
# define a helper function to generate an ex-gaussian

exGausDist <- function(nObs = 1000,mu = 400, sd = 40, tau = 200) {
  round(rnorm(nObs,mu,sd)+rexp(nObs,1/tau))
}

exampleDists <- data.frame("Reference" = exGausDist(),
                           "Minus 1 Sd" = c(exGausDist(nObs = 800),exGausDist(nObs = 200,mu = 200)),
                           "Plus 1 Sd" = c(exGausDist(nObs = 800),exGausDist(nObs = 200,mu = 600)),
                           "Plus 2 Sd" = c(exGausDist(nObs = 800),exGausDist(nObs = 200,mu = 800)))

exampleDists %>% gather(distribution,RT) %>%
  ggplot(aes(x = RT))+
  geom_histogram()+
  facet_wrap(~distribution)+
  theme_bw()

```

Ratcliff (1993) ran simulations testing how various methods of dealing with outliers stood up. Let's start by building a helper function to generate data with specified proportion of outliers. Ratcliff generated outliers by drawing from the reference ex-Gaussian distribution with a probability of 90%. Outliers were generated by adding a number between 0 and 2000 drawn from a uniform distribution to one of the numbers from the genuine distribution. Ratcliff also introduced inter-subject variability by vary individual subject means by a random number between -50 and 50, again drawn from a uniform distribution.

```{r ratcliffData}
exGausDist <- function(nObs = 1000,mu = 400, sd = 40, tau = 200, outProb = .1) {
  #generate vector of trials
  tmp <- round(rnorm(nObs,mu,sd)+rexp(nObs,1/tau))
  #pick the lucky ones
  rollD <- rbinom(nObs,1,prob = outProb) 
  outliers <- round(runif(nObs,0,2000))
  tmp[rollD] <- tmp[rollD]+outliers[rollD]
  tmp
}

## Custom function to generate a Ratcliff style dataset
## Main effect is always in A
ratcliff <- function(nSubs = 32, mainEffect = 0, mu = 400, subjVar = 50, nObs = 7,outProb = 0) {
  tmp <- data.frame(A1.B1 = unlist(replicate(nSubs,
                                             exGausDist(nObs,mu = mu,sd = 40,tau = 200,outProb = outProb),
                                             simplify = FALSE)),
                    A1.B2 = unlist(replicate(nSubs,
                                             exGausDist(nObs, mu = mu,sd = 40,tau = 200,outProb = outProb),
                                             simplify = FALSE)),
                    A2.B1 = unlist(replicate(nSubs,
                                             exGausDist(nObs,mu = mu + mainEffect,sd = 40,tau = 200,outProb = outProb),
                                             simplify = FALSE)),
                    A2.B2 = unlist(replicate(nSubs,
                                             exGausDist(nObs,mu = mu + mainEffect,sd = 40,tau = 200,outProb = outProb),
                                             simplify = FALSE)),
                    Subject = factor(rep(1:nSubs,each = nObs)),
                    SubOffset = rep(round(runif(nSubs,-subjVar,subjVar)),each = nObs))
  
  tmp <- tmp %>% 
    gather(condition,RT,-Subject,-SubOffset) %>%
    separate(condition,c("A","B"))
  
  tmp$shiftRT <- tmp$RT+tmp$SubOffset
  tmp
}

z <- ratcliff()

ggplot(z,aes(shiftRT))+
  geom_density(aes(fill = Subject),alpha = 0.5)+
  facet_grid(B~A)+
  theme_bw()
```

So now we have a function that can simulate Ratcliff's simulated datasets.

Ratcliff generated 1000 simulated datasets and ran a 2X2X32(!) ANOVA for each one using a variety of methods for dealing with outliers. This in itself seems a bit odd, as you wouldn't normally do that - you'd do a 2x2 repeated measures ANOVA, which is what I'll be doing.

Let's write yet another function: this one generates a dataset using the ratcliff function I wrote above and runs an ANOVA on it. We'll keep it simple to start off with and 

```{r}
runSims <- function(mainEffect = 0, outProb = 0 , nObs = 7) {
  
  tmp <- ratcliff(mainEffect = mainEffect,outProb = outProb,nObs = nObs)
  
  zz <- tmp %>% 
    group_by(Subject,A,B) %>%
    summarise(meanRT = mean(shiftRT)) %>%
    aov_ez("Subject","meanRT", data = .,within = c("A","B"))
  pA <- zz$anova_table$`Pr(>F)`[1]
  pB <- zz$anova_table$`Pr(>F)`[2]
  pAxB <- zz$anova_table$`Pr(>F)`[3]
  return(list("pA" = pA,"pB" = pB,"pAxB" = pAxB))
}

nSims <- 1000
out <- replicate(nSims,runSims())
mean(out[1,]<.05)
mean(out[2,]<.05)
mean(out[3,]<.05)
out <- replicate(nSims,runSims(mainEffect = 30))
mean(out[1,]<.05)
mean(out[2,]<.05)
mean(out[3,]<.05)
out <- replicate(nSims,runSims(mainEffect = 30, outProb = 0.05))
mean(out[1,]<.05)
mean(out[2,]<.05)
mean(out[3,]<.05)
out <- replicate(nSims,runSims(mainEffect = 30, outProb = 0.05, nObs = 14))
mean(out[1,]<.05)
mean(out[2,]<.05)
mean(out[3,]<.05)
out <- replicate(nSims,runSims(mainEffect = 30, outProb = 0.05, nObs = 21))
mean(out[1,]<.05)
mean(out[2,]<.05)
mean(out[3,]<.05)
```
```{r}
runSims <- function(mainEffect = 0, outProb = 0 , nObs = 7) {
  
  tmp <- ratcliff(mainEffect = mainEffect,outProb = outProb,nObs = nObs)
  
  zz <- tmp %>% 
    group_by(Subject,A,B) %>%
    summarise(meanRT = median(shiftRT)) %>%
    aov_ez("Subject","meanRT", data = .,within = c("A","B"))
  pA <- zz$anova_table$`Pr(>F)`[1]
  pB <- zz$anova_table$`Pr(>F)`[2]
  pAxB <- zz$anova_table$`Pr(>F)`[3]
  return(list("pA" = pA,"pB" = pB,"pAxB" = pAxB))
}

nSims <- 1000
out <- replicate(nSims,runSims())
mean(out[1,]<.05)
mean(out[2,]<.05)
mean(out[3,]<.05)
out <- replicate(nSims,runSims(mainEffect = 30))
mean(out[1,]<.05)
mean(out[2,]<.05)
mean(out[3,]<.05)
out <- replicate(nSims,runSims(mainEffect = 30, outProb = 0.05))
mean(out[1,]<.05)
mean(out[2,]<.05)
mean(out[3,]<.05)
out <- replicate(nSims,runSims(mainEffect = 30, outProb = 0.05, nObs = 14))
mean(out[1,]<.05)
mean(out[2,]<.05)
mean(out[3,]<.05)
out <- replicate(nSims,runSims(mainEffect = 30, outProb = 0.05, nObs = 21))
mean(out[1,]<.05)
mean(out[2,]<.05)
mean(out[3,]<.05)
```
```{r}
runSims <- function(mainEffect = 0, outProb = 0 , nObs = 7) {
  
  tmp <- ratcliff(mainEffect = mainEffect,outProb = outProb,nObs = nObs)
  
  zz <- tmp %>% 
    group_by(Subject,A,B) %>%
    filter(shiftRT <=1000) %>%
    summarise(meanRT = mean(shiftRT)) %>%
    aov_ez("Subject","meanRT", data = .,within = c("A","B"))
  pA <- zz$anova_table$`Pr(>F)`[1]
  pB <- zz$anova_table$`Pr(>F)`[2]
  pAxB <- zz$anova_table$`Pr(>F)`[3]
  return(list("pA" = pA,"pB" = pB,"pAxB" = pAxB))
}

nSims <- 1000
out <- replicate(nSims,runSims())
mean(out[1,]<.05)
mean(out[2,]<.05)
mean(out[3,]<.05)
out <- replicate(nSims,runSims(mainEffect = 30))
mean(out[1,]<.05)
mean(out[2,]<.05)
mean(out[3,]<.05)
out <- replicate(nSims,runSims(mainEffect = 30, outProb = 0.05))
mean(out[1,]<.05)
mean(out[2,]<.05)
mean(out[3,]<.05)
out <- replicate(nSims,runSims(mainEffect = 30, outProb = 0.05, nObs = 14))
mean(out[1,]<.05)
mean(out[2,]<.05)
mean(out[3,]<.05)
out <- replicate(nSims,runSims(mainEffect = 30, outProb = 0.05, nObs = 21))
mean(out[1,]<.05)
mean(out[2,]<.05)
mean(out[3,]<.05)
```

