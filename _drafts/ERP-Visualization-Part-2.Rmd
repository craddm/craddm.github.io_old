---
title: "ERP visualization with three conditions"
output: html_document
layout: post
comments: true
categories: [EEG, ERPs, statistics, R, ggplot2]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,dev = 'svg')
options(contrasts = c("contr.sum","contr.poly"))
```

In part 1 I took a look at visualizing ERPs from two conditions at a single electrode. This time I'm going to look at three conditions. As in the previous post, I'll assume a basic familiarity with ERPs.

First I'll load in the full dataset, which contains ERPs for all conditions for all subjects and whip it into shape.

```{r preProc, message = FALSE}
library(ggplot2)
library(reshape2)
library(dplyr)
library(afex)
library(purrr)

levCatGAall <- read.csv("https://raw.githubusercontent.com/craddm/ExploringERPs/master/levCatGAall.csv",header=FALSE)
names(levCatGAall) <- c("ObjFull","ObjHP","ObjLP","NonLP","NonHP","NonFull","Time","Subject")
levCatGAall <- levCatGAall[c(1,2,3,6,5,4,7,8)] #this is just to switch the order of the columns so it's easier to label them correctly below.

levCatGAall <- levCatGAall[(levCatGAall$Time >= -100) & (levCatGAall$Time <= 400),]
levCatGAall$Subject <- as.factor(levCatGAall$Subject)
levCatGAall <- melt(levCatGAall,id.vars = c("Subject","Time"))
names(levCatGAall) <- c("Subject","Time","condition","amplitude")
levCatGAall$Object <- gl(2,11520,labels = c("Object","Non-Object"))
levCatGAall$Frequency <- gl(3,3840,labels = c("BB","HSF","LSF"))

ERP.plot <- ggplot(levCatGAall,aes(Time,amplitude))+
  scale_color_brewer(palette = "Set1")+
  theme_classic()
```

## The Plots

Let's start off with a basic, standard ERP plot.

```{r basicPlot, fig.height = 5, fig.width = 7}
ERP.plot +
  stat_summary(fun.y = mean,geom = "line",size = 1,aes(colour = Frequency)) +
  labs(x = "Time (ms)",y = expression(paste("Amplitude (",mu,"V)")),colour = "") +
  geom_vline(xintercept = 0,linetype = "dashed" ) +
  geom_hline(yintercept = 0,linetype = "dashed")
```

Looks pretty much like there's an effect of frequency in the P1 which carries on right into the N1 and P2 - BB images have higher amplitude responses than LSF or HSF images.

Let's add bootstrapped 95% confidence intervals. Note that you could add SE instead of confidence intervals by replacing **mean_cl_boot** with **mean_se**.

```{r CIPlot,fig.height = 5, fig.width = 7}
ERP.plot+
  stat_summary(fun.data = mean_cl_boot,geom = "ribbon",size = 1,aes(fill = Frequency),alpha = 0.3)+
  guides(fill = "none")+
  stat_summary(fun.y = mean,geom = "line",size = 1,aes(colour = Frequency),alpha = 0.8)+
  labs(x = "Time (ms)",y = expression(paste("Amplitude (",mu,"V)")),colour = "")+
  geom_vline(xintercept = 0,linetype = "dashed" )+
  geom_hline(yintercept = 0,linetype = "dashed")
```

There's a lot of overlap here, so the figure is starting to get a little muddy. It's not too bad yet, but as noted in the previous post, the CIs are not terribly useful for inference here because they show between-subject variability when what's interesting is the within-subject variability, the variability of the differences. Nevertheless, we'll plow on adding individual subject data.

```{r indivAndGroup, fig.height = 5, fig.width = 8}
ERP.plot +
  stat_summary(fun.y = mean,geom = "line",alpha = 0.4,aes(group =interaction(Subject,Frequency),colour = Frequency),size = 0.7) +
  guides(alpha= "none") +
  stat_summary(fun.data = mean_cl_normal,geom = "ribbon",alpha = 0.4,aes(colour = Frequency,fill =Frequency)) +
  stat_summary(fun.y = mean,geom = "line",size = 1,aes(colour = Frequency),alpha = 0.8) +
  labs(x = "Time (ms)",y = expression(paste("Amplitude (",mu,"V)")),colour = "") +
  guides(colour= "none") +
  geom_vline(xintercept = 0,linetype = "dashed") +
  geom_hline(yintercept = 0,linetype = "dashed")
```

Now it's becoming a messy. It's really difficult to tell the conditions apart properly in the individual traces. Poor choice of colours? Maybe, but I tried rendering this plot under multiple colour schemes and it simply didn't help. And this problem can only get worse when you add more conditions. It's useful in to have all the conditions on one plot to aid comparisons between them, but given how hard it is to tell them apart I find it hard to make out if there are any systematic, important differences. Of course, this might be specific to this particular dataset. In others, such a plot might reveal far greater variability, or suggest separate subgroups of participants. 

Let's split the conditions up.
  
```{r condSplit, fig.height = 5, fig.width = 8}
ERP.plot+
  facet_wrap(~Frequency)+
  stat_summary(fun.y = mean,geom = "line",aes(group = Subject),alpha = 0.3)+
  stat_summary(fun.data = mean_cl_boot,geom = "ribbon",alpha = 0.4)+
  guides(fill= "none")+
  stat_summary(fun.y = mean,geom = "line",size = 1)+
  labs(x = "Time (ms)",y = expression(paste("Amplitude (",mu,"V)")),colour = "")+
  geom_vline(xintercept = 0,linetype = "dashed" )+
  geom_hline(yintercept = 0,linetype = "dashed")
```

Now we have three subplots, each informative about a particular condition. The mental gymnastics to work out where the differences are are becoming harder, and I find myself relying on the condition means. Couple of points of note - you have a couple of people who look a bit odd in the 160-200 ms time window - where most people are going negative, they aren't. After 230 ms or so, the data in general seems much more variable. But I can tell that from the confidence intervals anyway. And since there's no way to tell which line belongs to which participant, it's impossible to know if it's the same participants showing the same patterns across conditions (although I'd say it's very likely in the early parts of the ERP at least). 

Despite my misgivings, these plots do give a lot more information about the underlying single subject ERPs behind the condition means, and in some circumstances could be quite helpful in spotting serious outliers or possible subgroups who respond in different ways. One should be quite careful about doing so, of course (more on that in another post, later).

Of course, what I'm really interested in here are the within-subject differences across conditions, so what we really *need* is some kind of difference wave.

## Difference waves

In the two condition post, life was simple. Two conditions only need a single difference wave. But as the number of conditions increases, the number of pairwise differences increases. For three conditions, you'd need three difference waves (BB-HSF, BB-LSF, HSF-LSF). For four conditions, you'd need six difference waves. But of course, you'd start off with an F-test to test whether any of the means differ from each other, and, if they do, we'd then run post-hoc t-tests to check which pairs of means differ. A simple starting point is thus the difference between each condition mean and the *grand* mean, the mean across all conditions. 

```{r diffPlotGroup, fig.height = 5, fig.width = 7}
levCatGAall$GA <- ave(levCatGAall$amplitude,levCatGAall$Time)
levCatGAall$GAdiff <- levCatGAall$amplitude-levCatGAall$GA

ERPdiff.plot <- ggplot(levCatGAall,aes(Time,amplitude))+
  scale_color_brewer(palette = "Set1")+
  theme_classic()

ERPdiff.plot+
  guides(fill = "none")+
  labs(x = "Time (ms)", y = expression(paste("Amplitude (",mu,"V)")),colour = "")+
  stat_summary(fun.y = mean,geom = "line",size = 1,aes(y = GAdiff,colour = Frequency),alpha = 0.8)+
  geom_vline(xintercept = 0,linetype = "dashed" )+
  geom_hline(yintercept = 0,linetype = "dashed")

```

As described in a previous [post on running t-tests](../blog/2016/10/06/ERP-Vis-Running-Tests), we can also add the results of a running ANOVA to our plot. We'll use the *afex* package to run the actual ANOVA and the *purrr* package to split the data into individual data frames for each timepoint. To start with we'll just use uncorrected p values. Note that you have to be careful to make sure that you choose the p-values from the right term in the ANOVA. With a one-way ANOVA this is not so tough, but here I'm actually running a 2 by 3 ANOVA, so there are actually three terms (Object, Frequency, and Object by Frequency). For the purposes of this post I'm focussing solely on Frequency.

```{r addSig, fig.height = 5, fig.width = 7}
#First run the ANOVA on each timepoint
FtestPurrAfx <- levCatGAall %>%
  split(.$Time) %>%
  map(~ aov_ez("Subject","amplitude",.,within = c("Object","Frequency"))) 

#Extract the p-values and correct them as desired.
levCatGAall$pval <- p.adjust(map_dbl(FtestPurrAfx,c(1,6,2)),"none")
levCatGAall$crit <- 0+(levCatGAall$pval <= .05)
levCatGAall$crit[levCatGAall$crit == 0] <- NA

ERPdiff.plot <- ggplot(levCatGAall,aes(Time,amplitude))+
  theme_classic()

ERPdiff.plot+
  guides(fill = "none")+
  labs(x = "Time (ms)", y = expression(paste("Amplitude (",mu,"V)")),colour = "")+
  stat_summary(fun.data = mean_se,geom = "ribbon",size = 1,aes(y = GAdiff,fill = Frequency),alpha = 0.5)+
  stat_summary(fun.y = mean,geom = "line",size = 1,aes(y = GAdiff,colour = Frequency))+
  geom_line(aes(x = Time, y = crit-3),na.rm = TRUE,size = 2)+
  geom_vline(xintercept = 0,linetype = "dashed" )+
  geom_hline(yintercept = 0,linetype = "dashed")
```

This shows that, in the uncorrected p values at least, there is a significant effect of frequency around 40 ms, and then from round 80 to 360 ms, and from around 370 - 380 ms. Of course, we can't tell from an F-test alone which means are significantly different from each other at any given time point, even if we can hazard a reasonable guess. It's pretty clear that BB images are diverging from the others much more than the others diverge from each other.

I've added the standard error 

```{r postHocOnF}

postHoc <- levCatGAall %>%
  split(.$Time) %>%
  map(~pairwise.t.test(.$amplitude,.$Frequency,paired = TRUE,p.adjust.methods="holm"))

pvals <- data.frame(Time = unique(na.omit(levCatGAall$Time)),
                    BBHSF = map_dbl(postHoc,c(3,1)),
                    BBLSF = map_dbl(postHoc,c(3,2)),
                    HSFLSF = map_dbl(postHoc,c(3,4)))

pvals$BBHSF <- 0+(pvals$BBHSF <= .05) 
pvals$BBLSF <- 0+(pvals$BBLSF <= .05)
pvals$HSFLSF <- 0+(pvals$HSFLSF <= .05)
pvals[pvals == 0] <- NA


ERPdiff.plot+
  guides(fill = "none")+
  labs(x = "Time (ms)", y = expression(paste("Amplitude (",mu,"V)")),colour = "")+
  stat_summary(fun.data = mean_se,geom = "ribbon",size = 1,aes(y = GAdiff,fill = Frequency),alpha = 0.5)+
  stat_summary(fun.y = mean,geom = "line",size = 1,aes(y = GAdiff,colour = Frequency))+
  geom_line(aes(x = Time, y = crit-3),na.rm = TRUE,size = 2)+
  geom_line(data = pvals, aes(x = Time, y = BBHSF-3.2),na.rm = TRUE,size = 2,color = "red",alpha = 0.6)+
  geom_line(data = pvals, aes(x = Time, y = BBLSF-3.4),na.rm = TRUE,size = 2,color = "green")+
  geom_line(data = pvals, aes(x = Time, y = HSFLSF-3.6),na.rm = TRUE,size = 2,color = "blue")+
  geom_vline(xintercept = 0,linetype = "dashed" )+
  geom_hline(yintercept = 0,linetype = "dashed")

```

In theory, we could add lines for each person's difference from the grand mean...

```{r diffPlotIndiv}
ERPdiff.plot+
  guides(fill = "none")+
  labs(x = "Time (ms)", y = expression(paste("Amplitude (",mu,"V)")),colour = "")+
  stat_summary(fun.y = mean,geom = "line",size = 1,aes(y = GAdiff,group = interaction(Subject,Frequency),colour = Frequency),alpha = 0.4)+
  stat_summary(fun.y = mean,geom = "line",size = 2,aes(y = GAdiff,colour = Frequency))+
  geom_vline(xintercept = 0,linetype = "dashed" )+
  geom_hline(yintercept = 0,linetype = "dashed")
```

...but if you can make sense of that, you have better eyesight than I have.


```{r diffPlotIndiv2}
ERPdiff.plot+
  guides(fill = "none")+
  labs(x = "Time (ms)", y = expression(paste("Amplitude (",mu,"V)")),colour = "")+
  stat_summary(fun.y = mean,geom = "line",size = 1,aes(y = GAdiff,group = Subject),alpha = 0.4)+
  stat_summary(fun.y = mean,geom = "line",size = 2,aes(y = GAdiff))+
  geom_vline(xintercept = 0,linetype = "dashed" )+
  geom_hline(yintercept = 0,linetype = "dashed")+
  facet_wrap(~Frequency)
```

```{r diffPlot2}
ERPdiff.plot+
  guides(fill = "none")+
  labs(x = "Time (ms)", y = expression(paste("Amplitude (",mu,"V)")),colour = "")+
  stat_summary(fun.data = mean_se,geom = "ribbon",size = 1,aes(y = GAdiff,fill = Frequency),alpha = 0.4)+
  stat_summary(fun.y = mean,geom = "line",size = 1,aes(y = GAdiff,colour = Frequency))+
  geom_vline(xintercept = 0,linetype = "dashed" )+
  geom_hline(yintercept = 0,linetype = "dashed")
```


As you can probably see from the above, with just three conditions, some of the recommendations for improving standard ERP figures start to fall down, in my opinion. 