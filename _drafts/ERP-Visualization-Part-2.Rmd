---
title: "ERP visualization with three conditions"
output: html_document
layout: post
comments: true
categories: [EEG, ERPs, statistics, R, ggplot2]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,dev = 'svg')
options(contrasts = c("contr.sum","contr.poly"))
```

In part 1 I took a look at visualizing ERPs from two conditions at a single electrode. This time I'm going to look at three conditions. As in the previous post, I'll assume a basic familiarity with ERPs.

First I'll load in the full dataset, which contains ERPs for all conditions for all subjects and whip it into shape.

```{r preProc}
library(ggplot2)
library(reshape2)
library(dplyr)
levCatGAall <- read.csv("C:/Users/Matt/Dropbox/BlogStuff/RMarkdown/levCatGAall.csv",header=FALSE)
names(levCatGAall) <- c("ObjFull","ObjHP","ObjLP","NonFull","NonHP","NonLP","Time","Subject")
levCatGAall <- levCatGAall[(levCatGAall$Time >= -100)& (levCatGAall$Time <= 400),]
levCatGAall$Subject <- as.factor(levCatGAall$Subject)
levCatGAall <- melt(levCatGAall,id.vars = c("Subject","Time"))
names(levCatGAall) <- c("Subject","Time","condition","amplitude")
levCatGAall$Object <- gl(2,11520,labels = c("Object","Non-Object"))
levCatGAall$Frequency <- gl(3,3840,labels = c("BB","HSF","LSF"))
levCatGAall$TimeFac <- as.factor(levCatGAall$Time)

ERP.plot <- ggplot(levCatGAall,aes(Time,amplitude))+
  scale_color_brewer(palette = "Set1")+
  theme_classic()
```

## The Plots

Let's start off with a basic, standard ERP plot.

```{r basicPlot, fig.height = 5, fig.width = 7}
ERP.plot +
  stat_summary(fun.y = mean,geom = "line",size = 1,aes(colour = Frequency)) +
  labs(x = "Time (ms)",y = expression(paste("Amplitude (",mu,"V)")),colour = "") +
  geom_vline(xintercept = 0,linetype = "dashed" ) +
  geom_hline(yintercept = 0,linetype = "dashed")
```

Looks pretty much like there's not a lot of difference in the P1, but HSF and BB are more negative in the N1 and P2. 

Let's add 95% confidence intervals.

```{r CIPlot,fig.height = 5, fig.width = 7}
ERP.plot+
  stat_summary(fun.data = mean_cl_boot,geom = "ribbon",size = 1,aes(fill = Frequency),alpha = 0.3)+
  guides(fill = "none")+
  stat_summary(fun.y = mean,geom = "line",size = 1,aes(colour = Frequency),alpha = 0.8)+
  labs(x = "Time (ms)",y = expression(paste("Amplitude (",mu,"V)")),colour = "")+
  geom_vline(xintercept = 0,linetype = "dashed" )+
  geom_hline(yintercept = 0,linetype = "dashed")
```

There's a lot of overlap here, so the picture is starting to get muddy. As noted in the previous post, the CIs are not terribly useful for inference here because they show between-subject variability when what's interesting is the within-subject variability, the variability of the differences. Nevertheless, we'll plow on adding individual subject data.


```{r indivAndGroup, fig.height = 5, fig.width = 8}
ERP.plot +
  stat_summary(fun.y = mean,geom = "line",alpha = 0.4,aes(group =interaction(Subject,Frequency),colour = Frequency),size = 0.7) +
  guides(alpha= "none") +
  stat_summary(fun.data = mean_cl_boot,geom = "ribbon",alpha = 0.4,aes(fill = Frequency)) +
  stat_summary(fun.y = mean,geom = "line",size = 1,aes(colour = Frequency),alpha = 0.8) +
  labs(x = "Time (ms)",y = expression(paste("Amplitude (",mu,"V)")),colour = "") +
  guides(colour= "none") +
  geom_vline(xintercept = 0,linetype = "dashed") +
  geom_hline(yintercept = 0,linetype = "dashed")
```

Now it's becoming a real mess. It's really difficult to tell the conditions apart properly in the individual traces. Poor choice of colours? Maybe, but I tried rendering this plot under multiple colour schemes and it simply didn't help. And this problem can only get worse when you add more conditions. Let's split the conditions up.
  
```{r condSplit, fig.height = 5, fig.width = 8}
ERP.plot+
  facet_wrap(~Frequency)+
  stat_summary(fun.y = mean,geom = "line",aes(group = Subject),alpha = 0.3)+
  stat_summary(fun.data = mean_cl_boot,geom = "ribbon",alpha = 0.4)+
  guides(fill= "none")+
  stat_summary(fun.y = mean,geom = "line",size = 1)+
  labs(x = "Time (ms)",y = expression(paste("Amplitude (",mu,"V)")),colour = "")+
  geom_vline(xintercept = 0,linetype = "dashed" )+
  geom_hline(yintercept = 0,linetype = "dashed")
```

Now we have three subplots, each informative about a particular condition. The mental gymnastics to work out where the differences are are becoming harder, and I find myself relying on the condition means. 

## Difference waves

In the two condition post, life was simple. A difference wave was a difference wave. In the three condition post, well, now we have multiple possible difference waves...

Typically we'd be running an F-test to check for differences among the means. What we need to plot for that is the difference between each condition mean and the *grand* mean, the mean across all conditions. 

```{r diffPlotGroup, fig.height = 5, fig.width = 7}
levCatGAall$GA <- ave(levCatGAall$amplitude,levCatGAall$Time)
levCatGAall$GAdiff <- levCatGAall$amplitude-levCatGAall$GA

library(purrr)

FtestPurrezAOV <- levCatGAall %>%
  split(.$Time) %>%
  map(~ ezANOVA(data = ., wid = Subject,within = .(Object,Frequency),dv = amplitude)) %>%
  map_dbl(.,c(1,5,2))


FtestPurrAfx <- levCatGAall %>%
  split(.$Time) %>%
  map(~ aov_ez("Subject","amplitude",.,within = c("Object","Frequency"))) %>%
  map_dbl(.,c(1,6,2))
  
levCatGAall$pval <- p.adjust(FtestPurrezAOV,"fdr")
levCatGAall$pval[levCatGAall$pval > .05] <- NA

ERPdiff.plot <- ggplot(levCatGAall,aes(Time,amplitude))+
  theme_classic()

ERPdiff.plot+
  guides(fill = "none")+
  labs(x = "Time (ms)", y = expression(paste("Amplitude (",mu,"V)")),colour = "")+
  stat_summary(fun.y = mean,geom = "line",size = 1,aes(y = GAdiff,fill = Frequency),alpha = 0.4)+
  stat_summary(fun.y = mean,geom = "line",size = 1,aes(y = GAdiff,colour = Frequency))+
  stat_summary(fun.y = mean,geom= "point",aes(y = pval-2))+
  geom_vline(xintercept = 0,linetype = "dashed" )+
  geom_hline(yintercept = 0,linetype = "dashed")


ERPdiff.plot+
  guides(fill = "none")+
  labs(x = "Time (ms)", y = expression(paste("Amplitude (",mu,"V)")),colour = "")+
  stat_summary(fun.data = mean_se,geom = "ribbon",size = 1,aes(y = GAdiff,fill = Frequency),alpha = 0.4)+
  stat_summary(fun.y = mean,geom = "line",size = 1,aes(y = GAdiff,colour = Frequency))+
  stat_summary(fun.y = mean,geom= "point",aes(y = pval-2))+
  geom_vline(xintercept = 0,linetype = "dashed" )+
  geom_hline(yintercept = 0,linetype = "dashed")


ERPdiff.plot+
  guides(fill = "none")+
  labs(x = "Time (ms)", y = expression(paste("Amplitude (",mu,"V)")),colour = "")+
  stat_summary(fun.data = mean_se,geom = "ribbon",size = 1,aes(y = GAdiff,fill = Frequency),alpha = 0.4)+
  stat_summary(fun.y = mean,fun.args = list(trim = 0.05),geom = "line",size = 1,aes(y = GAdiff,colour = Frequency))+
  stat_summary(fun.y = mean,geom= "line",aes(y = pval-2))+
  geom_vline(xintercept = 0,linetype = "dashed" )+
  geom_hline(yintercept = 0,linetype = "dashed")




ERPdiff.plot+
  guides(fill = "none")+
  labs(x = "Time (ms)", y = expression(paste("Amplitude (",mu,"V)")),colour = "")+
  stat_summary(fun.data = mean_cl_boot,geom = "ribbon",size = 1,aes(y = GAdiff,fill = Frequency),alpha = 0.4)+
  stat_summary(fun.y = mean,geom = "line",size = 1,aes(y = GAdiff,colour = Frequency,group = interaction(Subject,Frequency),alpha = 0.4))+
  geom_vline(xintercept = 0,linetype = "dashed" )+
  geom_hline(yintercept = 0,linetype = "dashed")

```